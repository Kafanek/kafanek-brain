# üèóÔ∏è KAF√ÅNEK BRAIN - ARCHITEKTURA v1.2.0

**Verze:** 1.2.0  
**Datum:** 2025-10-03  
**Architektura:** Zjednodu≈°en√° funkƒçn√≠ implementace  

---

## üìê P≈òEHLED ARCHITEKTURY

### Design Principles
1. **Simplicity First** - Jednoduch√Ω, ƒçiteln√Ω, udr≈æovateln√Ω k√≥d
2. **Modular Design** - Nez√°visl√© moduly s jasn√Ωm rozhran√≠m
3. **WordPress Native** - Pou≈æ√≠v√° WordPress standards (hooks, filters, REST API)
4. **Security First** - Nonce verification, capability checks, sanitization
5. **Performance** - Transient caching, lazy loading, optimalizovan√© dotazy

---

## üóÇÔ∏è STRUKTURA SOUBOR≈Æ

```
kafanek-brain/
‚îÇ
‚îú‚îÄ‚îÄ kafanek-brain.php                    # [CORE] Main plugin file
‚îÇ   ‚îú‚îÄ‚îÄ Class: Kafanek_Brain_Plugin
‚îÇ   ‚îú‚îÄ‚îÄ Singleton pattern
‚îÇ   ‚îú‚îÄ‚îÄ Module loader
‚îÇ   ‚îú‚îÄ‚îÄ REST API registration
‚îÇ   ‚îú‚îÄ‚îÄ AJAX handlers
‚îÇ   ‚îî‚îÄ‚îÄ Database schema
‚îÇ
‚îú‚îÄ‚îÄ includes/                            # [CORE LOGIC]
‚îÇ   ‚îî‚îÄ‚îÄ class-ai-engine.php              # AI Engine
‚îÇ       ‚îú‚îÄ‚îÄ Class: Kafanek_AI_Engine
‚îÇ       ‚îú‚îÄ‚îÄ OpenAI API integration
‚îÇ       ‚îú‚îÄ‚îÄ Text generation
‚îÇ       ‚îú‚îÄ‚îÄ Product description generator
‚îÇ       ‚îú‚îÄ‚îÄ SEO content analyzer
‚îÇ       ‚îî‚îÄ‚îÄ Usage logging
‚îÇ
‚îú‚îÄ‚îÄ modules/                             # [FEATURES]
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.php                  # Core helper functions (v1.1.0)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Class: Kafanek_Core_Helpers
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Fibonacci caching (9 levels)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Golden Ratio calculations
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Cosine similarity (ML)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Feature extraction
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Retry with Fibonacci delays
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ woocommerce/
‚îÇ       ‚îî‚îÄ‚îÄ class-woocommerce-ai.php     # WooCommerce integration
‚îÇ           ‚îú‚îÄ‚îÄ Class: Kafanek_WooCommerce_AI
‚îÇ           ‚îú‚îÄ‚îÄ AI metabox in product editor
‚îÇ           ‚îú‚îÄ‚îÄ Generate description AJAX
‚îÇ           ‚îú‚îÄ‚îÄ Optimize price (Golden Ratio)
‚îÇ           ‚îú‚îÄ‚îÄ Product recommendations
‚îÇ           ‚îî‚îÄ‚îÄ Frontend widgets
‚îÇ
‚îú‚îÄ‚îÄ admin/                               # [ADMIN UI]
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.php                    # Main dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Statistics (requests, tokens)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Recent AI logs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Quick actions
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ settings.php                     # Settings page
‚îÇ       ‚îú‚îÄ‚îÄ API key configuration
‚îÇ       ‚îú‚îÄ‚îÄ Module toggles
‚îÇ       ‚îú‚îÄ‚îÄ System status
‚îÇ       ‚îî‚îÄ‚îÄ API test button
‚îÇ
‚îî‚îÄ‚îÄ assets/                              # [FRONTEND]
    ‚îú‚îÄ‚îÄ js/
    ‚îÇ   ‚îú‚îÄ‚îÄ kafanek-brain.js             # Frontend JavaScript
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AI chat widget
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Recommendations UI
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AJAX handlers
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ admin.js                     # Admin JavaScript
    ‚îÇ       ‚îú‚îÄ‚îÄ API testing
    ‚îÇ       ‚îú‚îÄ‚îÄ Cache management
    ‚îÇ       ‚îî‚îÄ‚îÄ Module toggles
    ‚îÇ
    ‚îî‚îÄ‚îÄ css/
        ‚îî‚îÄ‚îÄ kafanek-brain.css            # Styles
            ‚îú‚îÄ‚îÄ AI recommendations grid
            ‚îú‚îÄ‚îÄ Chat widget
            ‚îî‚îÄ‚îÄ Responsive design
```

---

## üîÑ DATOV√ù TOK

### 1. Plugin Initialization Flow

```
WordPress Loads
    ‚Üì
plugins_loaded hook (priority 5)
    ‚Üì
Kafanek_Brain_Plugin::get_instance()
    ‚Üì
__construct()
    ‚îú‚îÄ‚îÄ register_activation_hook()
    ‚îú‚îÄ‚îÄ register_deactivation_hook()
    ‚îî‚îÄ‚îÄ add_action('plugins_loaded', 'init', 5)
    ‚Üì
init()
    ‚îú‚îÄ‚îÄ load_core_helpers()           # Priority: First
    ‚îÇ   ‚îî‚îÄ‚îÄ modules/core/helpers.php
    ‚îú‚îÄ‚îÄ load_modules()
    ‚îÇ   ‚îú‚îÄ‚îÄ WooCommerce AI (if WC active)
    ‚îÇ   ‚îú‚îÄ‚îÄ Elementor Widgets (if Elementor active)
    ‚îÇ   ‚îî‚îÄ‚îÄ Neural Network (if enabled)
    ‚îî‚îÄ‚îÄ init_ai_engine()
        ‚îî‚îÄ‚îÄ includes/class-ai-engine.php
    ‚Üì
Plugin Ready ‚úÖ
```

### 2. AI Product Description Generation Flow

```
User clicks "üìù Generovat popis" in Product Editor
    ‚Üì
JavaScript (metabox script)
    ‚îú‚îÄ‚îÄ AJAX POST ‚Üí ajaxurl
    ‚îú‚îÄ‚îÄ action: 'kafanek_woo_generate_description'
    ‚îú‚îÄ‚îÄ product_id: [ID]
    ‚îî‚îÄ‚îÄ nonce: [security token]
    ‚Üì
Kafanek_WooCommerce_AI::ajax_generate_description()
    ‚îú‚îÄ‚îÄ check_ajax_referer('kafanek_ai_nonce')  # Security
    ‚îú‚îÄ‚îÄ intval($_POST['product_id'])            # Sanitization
    ‚îî‚îÄ‚îÄ $this->ai_engine->generate_product_description($product_id)
    ‚Üì
Kafanek_AI_Engine::generate_product_description()
    ‚îú‚îÄ‚îÄ wc_get_product($product_id)
    ‚îú‚îÄ‚îÄ Build prompt with:
    ‚îÇ   ‚îú‚îÄ‚îÄ Product name
    ‚îÇ   ‚îú‚îÄ‚îÄ Categories
    ‚îÇ   ‚îî‚îÄ‚îÄ Price
    ‚îú‚îÄ‚îÄ $description = generate_text($prompt)
    ‚îÇ   ‚îú‚îÄ‚îÄ Check cache (md5 hash)
    ‚îÇ   ‚îú‚îÄ‚îÄ If cached ‚Üí return from transient
    ‚îÇ   ‚îî‚îÄ‚îÄ If not cached:
    ‚îÇ       ‚îú‚îÄ‚îÄ wp_remote_post(OpenAI API)
    ‚îÇ       ‚îú‚îÄ‚îÄ Parse response
    ‚îÇ       ‚îú‚îÄ‚îÄ set_transient (1 hour)
    ‚îÇ       ‚îî‚îÄ‚îÄ log_usage()
    ‚îú‚îÄ‚îÄ $short = generate_text($short_prompt)
    ‚îî‚îÄ‚îÄ return ['description' => ..., 'short_description' => ...]
    ‚Üì
JavaScript receives response
    ‚îú‚îÄ‚îÄ tinyMCE.get('content').setContent(response.data.description)
    ‚îú‚îÄ‚îÄ $('#excerpt').val(response.data.short_description)
    ‚îî‚îÄ‚îÄ Show success message
    ‚Üì
User saves product ‚úÖ
```

### 3. Price Optimization Flow

```
User clicks "üí∞ Optimalizovat cenu"
    ‚Üì
Kafanek_WooCommerce_AI::ajax_optimize_price()
    ‚îú‚îÄ‚îÄ wc_get_product($product_id)
    ‚îú‚îÄ‚îÄ $current_price = $product->get_price()
    ‚îú‚îÄ‚îÄ Golden Ratio Calculation:
    ‚îÇ   ‚îú‚îÄ‚îÄ $golden_ratio = 1.618
    ‚îÇ   ‚îú‚îÄ‚îÄ $optimal = round($current_price * $golden_ratio / 10) * 10
    ‚îÇ   ‚îî‚îÄ‚îÄ Safety check (max 2x current)
    ‚îî‚îÄ‚îÄ return ['current' => ..., 'optimal' => ..., 'change' => ...]
    ‚Üì
JavaScript
    ‚îú‚îÄ‚îÄ Display recommendation
    ‚îú‚îÄ‚îÄ if (confirm()) ‚Üí update price field
    ‚îî‚îÄ‚îÄ User saves ‚úÖ
```

### 4. REST API Status Flow

```
GET /wp-json/kafanek-brain/v1/status
    ‚Üì
Kafanek_Brain_Plugin::get_status()
    ‚îú‚îÄ‚îÄ Check modules loaded
    ‚îú‚îÄ‚îÄ Check API key configured
    ‚îî‚îÄ‚îÄ return JSON:
        {
          "status": "active",
          "version": "1.2.0",
          "modules": {...},
          "ai_ready": true/false
        }
```

---

## üîå API DOKUMENTACE

### REST API Endpoints

#### 1. Status Endpoint
```
GET /wp-json/kafanek-brain/v1/status
```

**Response:**
```json
{
  "status": "active",
  "version": "1.2.0",
  "modules": {
    "helpers": true,
    "WooCommerce AI": true
  },
  "ai_ready": true
}
```

**Permission:** Public (v≈°ichni)

---

#### 2. Generate Content Endpoint
```
POST /wp-json/kafanek-brain/v1/generate
```

**Headers:**
```
X-Kafanek-API-Key: [your-api-key]
```

**Request Body:**
```json
{
  "prompt": "Generate product description...",
  "options": {
    "temperature": 0.7,
    "max_tokens": 500
  }
}
```

**Response:**
```json
{
  "success": true,
  "text": "Generated content..."
}
```

**Permission:** API Key required

---

#### 3. Recommendations Endpoint
```
GET /wp-json/kafanek-brain/v1/recommendations?product_id=123
```

**Response:**
```json
{
  "recommendations": [45, 67, 89, 123]
}
```

**Permission:** Public

---

### AJAX Handlers

#### 1. Generate Product Description
```javascript
jQuery.post(ajaxurl, {
  action: 'kafanek_woo_generate_description',
  product_id: 123,
  nonce: wp_nonce
})
```

**Handler:** `Kafanek_WooCommerce_AI::ajax_generate_description()`

---

#### 2. Optimize Price
```javascript
jQuery.post(ajaxurl, {
  action: 'kafanek_woo_optimize_price',
  product_id: 123,
  nonce: wp_nonce
})
```

**Handler:** `Kafanek_WooCommerce_AI::ajax_optimize_price()`

---

#### 3. AI Chat Request
```javascript
jQuery.post(ajaxurl, {
  action: 'kafanek_ai_request',
  ai_action: 'chat',
  data: { message: 'Hello AI' },
  nonce: wp_nonce
})
```

**Handler:** `Kafanek_Brain_Plugin::handle_ai_request()`

---

## üóÑÔ∏è DATAB√ÅZOV√Å STRUKTURA

### Table: `wp_kafanek_ai_logs`

```sql
CREATE TABLE wp_kafanek_ai_logs (
  id bigint(20) NOT NULL AUTO_INCREMENT,
  request_type varchar(50) NOT NULL,        -- 'openai', 'chat', etc.
  request_data longtext,                    -- JSON: prompt, params
  response_data longtext,                   -- JSON: response
  tokens_used int(11),                      -- Cost tracking
  created_at datetime DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (id),
  KEY request_type (request_type),
  KEY created_at (created_at)
);
```

**Purpose:**
- Usage tracking
- Cost monitoring
- Debugging
- Analytics

**Queries:**
```php
// Total requests
$wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->prefix}kafanek_ai_logs");

// Total tokens
$wpdb->get_var("SELECT SUM(tokens_used) FROM {$wpdb->prefix}kafanek_ai_logs");

// Recent logs
$wpdb->get_results("SELECT * FROM {$wpdb->prefix}kafanek_ai_logs ORDER BY created_at DESC LIMIT 10");
```

---

### WordPress Options

```php
// API Key (sensitive!)
get_option('kafanek_brain_api_key');  // string

// Active modules
get_option('kafanek_brain_modules');  // array
[
  'woocommerce' => true,
  'elementor' => true,
  'neural' => false
]
```

---

### Transients (Cache)

```php
// AI response cache (1 hour)
$cache_key = 'kafanek_ai_' . md5($prompt . json_encode($options));
set_transient($cache_key, $result, HOUR_IN_SECONDS);

// Product recommendations (6 hours)
$cache_key = 'kafanek_rec_' . $product_id;
set_transient($cache_key, $recommendations, 6 * HOUR_IN_SECONDS);
```

---

## üîê BEZPEƒåNOSTN√ç MODEL

### 1. Nonce Verification

```php
// AJAX handlers ALWAYS verify nonce
check_ajax_referer('kafanek_ai_nonce', 'nonce');
```

**Ochrana proti:** CSRF attacks

---

### 2. Capability Checks

```php
// Admin settings
if (!current_user_can('manage_options')) {
    return;
}

// Product editing
if (!current_user_can('edit_products')) {
    wp_send_json_error('Insufficient permissions');
}
```

**Ochrana proti:** Unauthorized access

---

### 3. Input Sanitization

```php
// API key
update_option('kafanek_brain_api_key', sanitize_text_field($_POST['api_key']));

// Product ID
$product_id = intval($_POST['product_id']);
```

**Ochrana proti:** SQL injection, XSS

---

### 4. Output Escaping

```php
// Admin UI
echo esc_html($request->created_at);
echo esc_attr($api_key);
echo esc_url($permalink);
```

**Ochrana proti:** XSS

---

### 5. API Key Storage

**Options:**

1. **Database (default):**
   ```php
   update_option('kafanek_brain_api_key', $key);
   ```

2. **wp-config.php (recommended for production):**
   ```php
   define('KAFANEK_OPENAI_API_KEY', 'sk-...');
   ```

3. **.env file (advanced):**
   ```bash
   KAFANEK_OPENAI_API_KEY=sk-...
   ```

**Best Practice:** Use wp-config.php or .env for production

---

## ‚ö° PERFORMANCE OPTIMALIZACE

### 1. Caching Strategy

**Transient Cache:**
```php
// Cache levels from helpers.php (v1.1.0)
$fibonacci_cache_levels = [
    'instant' => 1,      // 1 second
    'quick' => 1,        // 1 second
    'short' => 2,        // 2 seconds
    'medium' => 3,       // 3 seconds
    'standard' => 5,     // 5 seconds
    'long' => 8,         // 8 seconds
    'extended' => 13,    // 13 seconds
    'hourly' => 1260,    // 21 minutes
    'daily' => 122400    // 34 hours
];
```

**Usage:**
```php
kafanek_fibonacci_cache($key, $callback, 'hourly');
```

---

### 2. Lazy Loading

```php
// Modules load only when needed
if (class_exists('WooCommerce')) {
    $this->load_module('woocommerce/class-woocommerce-ai.php');
}
```

---

### 3. Database Optimization

```sql
-- Indexes on frequently queried columns
KEY request_type (request_type),
KEY created_at (created_at)
```

---

### 4. Frontend Optimization

**CSS:**
- Minified in production
- Critical CSS inline
- Lazy load non-critical

**JavaScript:**
- Loaded in footer
- jQuery dependency
- Conditional loading (only where needed)

---

## üß© INTEGRAƒåN√ç BODY

### WordPress Hooks

**Actions:**
```php
add_action('plugins_loaded', [$this, 'init'], 5);
add_action('init', [$this, 'register_post_types']);
add_action('rest_api_init', [$this, 'register_rest_routes']);
add_action('admin_menu', [$this, 'add_admin_menu']);
add_action('wp_enqueue_scripts', [$this, 'enqueue_scripts']);
add_action('admin_enqueue_scripts', [$this, 'admin_scripts']);

// AJAX
add_action('wp_ajax_kafanek_ai_request', [$this, 'handle_ai_request']);
add_action('wp_ajax_nopriv_kafanek_ai_request', [$this, 'handle_ai_request']);
```

**Filters:**
```php
// Currently none, but available for extensions
apply_filters('kafanek_ai_prompt', $prompt, $product);
apply_filters('kafanek_optimal_price', $optimal, $current, $product);
```

---

### WooCommerce Integration

**Hooks:**
```php
add_action('woocommerce_single_product_summary', [$this, 'show_ai_recommendations'], 35);
add_action('woocommerce_product_options_pricing', [$this, 'add_ai_price_field']);
add_action('woocommerce_process_product_meta', [$this, 'save_ai_fields']);
add_action('add_meta_boxes', [$this, 'add_ai_metabox']);
```

---

### Elementor Integration

**Planned (v1.3.0):**
```php
add_action('elementor/widgets/register', [$this, 'register_widgets']);
```

---

## üìä MONITORING & LOGGING

### Debug Mode

```php
if (defined('WP_DEBUG') && WP_DEBUG) {
    error_log('Kafanek Brain: Core helpers loaded');
}
```

**Location:** `/wp-content/debug.log`

---

### Usage Tracking

```php
private function log_usage($prompt, $response, $usage) {
    global $wpdb;
    
    $wpdb->insert($wpdb->prefix . 'kafanek_ai_logs', [
        'request_type' => 'openai',
        'request_data' => json_encode(['prompt' => $prompt]),
        'response_data' => json_encode(['response' => $response]),
        'tokens_used' => $usage['total_tokens'] ?? 0,
        'created_at' => current_time('mysql')
    ]);
}
```

---

### Dashboard Metrics

**Tracked:**
- üìä Total requests
- üéØ Total tokens used
- ‚è±Ô∏è Response times (planned)
- üí∞ Estimated costs (planned)

---

## üöÄ DEPLOYMENT CHECKLIST

```bash
[ ] K√≥d commitnut do GIT (bez API kl√≠ƒçe!)
[ ] Database backup vytvo≈ôen
[ ] API kl√≠ƒç nakonfigurov√°n
[ ] WP_DEBUG = false
[ ] SSL certifik√°t aktivn√≠
[ ] Cache plugin kompatibiln√≠
[ ] Cron jobs funkƒçn√≠
[ ] Error logging nastaven
[ ] Performance test dokonƒçen
[ ] Security audit proveden
[ ] Dokumentace aktu√°ln√≠
```

---

## üîÆ PL√ÅNOVAN√â FUNKCE (v1.3.0+)

### P≈ôipravovan√©:
- ‚ú® Elementor AI Widgets
- üß† Neural Network module
- üìà Advanced analytics dashboard
- üé® AI image generation (DALL-E)
- üåç Multi-language support
- üì± Mobile app API
- üîÑ Bulk product processing
- üí¨ Advanced chatbot

---

## üìö REFERENCE

### Dependencies
- **WordPress:** 6.0+
- **PHP:** 7.4+
- **WooCommerce:** 7.0+ (optional)
- **Elementor:** 3.0+ (optional)
- **OpenAI API:** GPT-3.5/4

### External APIs
- **OpenAI:** https://api.openai.com/v1/chat/completions

### Standards
- **WordPress Coding Standards:** https://developer.wordpress.org/coding-standards/
- **PSR-12:** https://www.php-fig.org/psr/psr-12/

---

**Architektura navr≈æena pro:** Jednoduchost, Bezpeƒçnost, Performance, ≈†k√°lovatelnost

**Autor:** Cascade AI + Kolibri Academy  
**Licence:** GPL v2 or later  
**Repository:** (internal)
